<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“š Admin - Manage Chapters</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-4xl">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“˜ ç®¡ç†ç« èŠ‚</h1>

    <form id="chapter-form" class="space-y-4 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700">Book ID</label>
        <input type="text" name="book_id" required class="mt-1 p-2 border border-gray-300 rounded w-full" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Chapter ID</label>
        <input type="text" name="chapter_id" required class="mt-1 p-2 border border-gray-300 rounded w-full" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Chapter Title</label>
        <input type="text" name="title" required class="mt-1 p-2 border border-gray-300 rounded w-full" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Chapter Content</label>
        <textarea name="content" rows="8" required class="mt-1 p-2 border border-gray-300 rounded w-full"></textarea>
      </div>

      <!-- New: Cover Upload Section -->
      <div>
        <label class="block text-sm font-medium text-gray-700">Cover Image URL (Optional)</label>
        <input type="url" name="coverUrl" placeholder="https://..." class="mt-1 p-2 border border-gray-300 rounded w-full" />
        <button type="button" id="set-cover-btn" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ğŸ“… è®¾ç½®ä¸ºä¹¦çš„å°é¢</button>
      </div>

      <button type="submit" class="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700">
        â• æ·»åŠ ç« èŠ‚
      </button>
    </form>

    <div id="result" class="mb-6 text-sm text-gray-600"></div>

    <table class="w-full table-auto text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="px-2 py-1">Book ID</th>
          <th class="px-2 py-1">Chapter ID</th>
          <th class="px-2 py-1">Title</th>
          <th class="px-2 py-1">åˆ›å»ºæ—¶é—´</th>
          <th class="px-2 py-1">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="chapter-table" class="divide-y"></tbody>
    </table>
  </div>

  <script type="module">
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½ç« èŠ‚åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', () => {
      loadChapters();
      setupFormSubmission();
    });

    // åŠ è½½æ‰€æœ‰ç« èŠ‚æ•°æ®
    async function loadChapters() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/chapters?select=*&order=book_id.asc,chapter_id.asc`, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`
          }
        });

        if (!response.ok) {
          throw new Error(`çŠ¶æ€ç : ${response.status}`);
        }

        const chapters = await response.json();
        displayChapters(chapters);
      } catch (error) {
        console.error('åŠ è½½ç« èŠ‚å¤±è´¥:', error);
        document.getElementById('chapter-table').innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-3 text-center text-red-500">
              åŠ è½½ç« èŠ‚æ•°æ®å¤±è´¥: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // åœ¨è¡¨æ ¼ä¸­æ˜¾ç¤ºç« èŠ‚æ•°æ®
    function displayChapters(chapters) {
      const tableBody = document.getElementById('chapter-table');
      
      if (chapters.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-3 text-center">æš‚æ— ç« èŠ‚æ•°æ®</td>
          </tr>
        `;
        return;
      }

      tableBody.innerHTML = chapters.map(chapter => `
        <tr class="hover:bg-gray-50">
          <td class="px-2 py-1">${chapter.book_id}</td>
          <td class="px-2 py-1">${chapter.chapter_id}</td>
          <td class="px-2 py-1">${chapter.title || '-'}</td>
          <td class="px-2 py-1">${new Date(chapter.created_at).toLocaleString()}</td>
          <td class="px-2 py-1">
            <button 
              class="bg-red-500 text-white px-2 py-1 rounded text-xs delete-btn" 
              data-book="${chapter.book_id}" 
              data-chapter="${chapter.chapter_id}">
              åˆ é™¤
            </button>
          </td>
        </tr>
      `).join('');

      // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDelete);
      });
    }

    // å¤„ç†åˆ é™¤ç« èŠ‚
    async function handleDelete(e) {
      const bookId = e.target.dataset.book;
      const chapterId = e.target.dataset.chapter;
      
      if (!confirm(`ç¡®å®šåˆ é™¤ä¹¦ç± "${bookId}" çš„ç« èŠ‚ "${chapterId}"?`)) {
        return;
      }
      
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/chapters?book_id=eq.${encodeURIComponent(bookId)}&chapter_id=eq.${encodeURIComponent(chapterId)}`, 
          {
            method: 'DELETE',
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );
        
        if (response.ok) {
          // é‡æ–°åŠ è½½ç« èŠ‚åˆ—è¡¨
          loadChapters();
          document.getElementById('result').textContent = `âœ… æˆåŠŸåˆ é™¤ç« èŠ‚`;
        } else {
          throw new Error(`çŠ¶æ€ç : ${response.status}`);
        }
      } catch (error) {
        console.error('åˆ é™¤ç« èŠ‚å¤±è´¥:', error);
        document.getElementById('result').textContent = `âŒ åˆ é™¤å¤±è´¥: ${error.message}`;
      }
    }

    // è®¾ç½®è¡¨å•æäº¤å¤„ç†
    function setupFormSubmission() {
      document.getElementById('chapter-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const chapterData = {
          book_id: formData.get('book_id'),
          chapter_id: formData.get('chapter_id'),
          title: formData.get('title'),
          content: formData.get('content'),
          cover_url: formData.get('coverUrl') || null,
          created_at: new Date().toISOString() // è‡ªåŠ¨è®¾ç½®å½“å‰æ—¶é—´ä¸ºåˆ›å»ºæ—¶é—´
        };
        
        try {
          const response = await fetch(`${SUPABASE_URL}/rest/v1/chapters`, {
            method: 'POST',
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(chapterData)
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`çŠ¶æ€ç : ${response.status}, ${errorText}`);
          }
          
          // æ¸…ç©ºè¡¨å•å¹¶é‡æ–°åŠ è½½ç« èŠ‚åˆ—è¡¨
          e.target.reset();
          loadChapters();
          document.getElementById('result').textContent = `âœ… æˆåŠŸæ·»åŠ ç« èŠ‚`;
        } catch (error) {
          console.error('æ·»åŠ ç« èŠ‚å¤±è´¥:', error);
          document.getElementById('result').textContent = `âŒ æ·»åŠ å¤±è´¥: ${error.message}`;
        }
      });
    }

    document.getElementById('set-cover-btn').addEventListener('click', async () => {
      const bookId = document.querySelector('[name=book_id]').value.trim();
      if (!bookId) return alert('è¯·å…ˆè¾“å…¥ Book ID');

      let coverUrl = document.querySelector('[name=coverUrl]').value.trim();
      if (!coverUrl) {
        // è‡ªåŠ¨æå–ç¬¬ä¸€ç« å°é¢
        const res = await fetch(`${SUPABASE_URL}/rest/v1/chapters?book_id=eq.${encodeURIComponent(bookId)}&order=chapter_id.asc&limit=1`, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        const data = await res.json();
        coverUrl = data?.[0]?.cover_url || 'https://flowbite.com/docs/images/examples/image-3@2x.jpg';
      }

      // æ›´æ–° books è¡¨ä¸­å°é¢å­—æ®µ
      const updateRes = await fetch(`${SUPABASE_URL}/rest/v1/books?book_id=eq.${encodeURIComponent(bookId)}`, {
        method: 'PATCH',
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cover_url: coverUrl })
      });

      const text = await updateRes.text();
      console.log('å°é¢è®¾ç½®ç»“æœ:', text);
      if (updateRes.ok) {
        alert('âœ… æˆåŠŸè®¾ç½®ä¸ºå°é¢');
      } else {
        alert('âŒ è®¾ç½®å¤±è´¥ï¼š' + text);
      }
    });
  </script>
</body>
</html>
